<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.enez.market.product.Service"> 
  
  <insert id="productsave">
    insert into product (seller_id, product_no, product_image, title, category_name, location, price, detail)
    values (#{param1}, pro_no.nextval, #{param2}, #{param3}, #{param4}, #{param5}, #{param6}, #{param7})
</insert>
	
<select id="productout" resultType="com.enez.market.product.ProductDTO">
	select * from product where title = #{param1}		
</select>

<update id="count">
	update product set view_cnt=view_cnt+1 where title = #{param1}
</update>

<select id="jjimcount" resultType="Integer" >
SELECT count(*) FROM PRODUCT_JJIM where PRODUCT_NO in #{param1}
</select>
<select id="jjimcheck" resultType="Integer" >
SELECT count(*) FROM PRODUCT_JJIM where USER_ID in #{param2} and PRODUCT_NO in #{param1} and SELLER_ID in #{param3}
</select>

 <insert id="jjimupdate_insert">
    insert into product_jjim (product_no, user_id, seller_id) values (#{param1},#{param2},#{param3})
</insert>
	
<delete id="jjimupdate_delet">
delete from PRODUCT_JJIM where USER_ID in #{param2} and PRODUCT_NO in #{param1} and SELLER_ID in #{param3}
</delete>


<!-- 마이페이지 기능 추가 -->

<select id="likejjim" resultType="String" >
SELECT PRODUCT_NO FROM PRODUCT_JJIM where USER_ID in #{param1}
</select>
<select id="getjjim" resultType="String" >
SELECT USER_ID FROM PRODUCT_JJIM where SELLER_ID in #{param1} GROUP BY user_id
</select>
<select id="idcheck" resultType="Integer">
	select count(*) from RESET_USER where MEMBER_ID = #{param1}
</select>

<select id="getCreateDate" resultType="com.enez.market.product.UserProfileDTO" >
SELECT 
	STDATE, PROFILE_IMAGE, NICKNAME,
	CASE WHEN manner is null THEN 5 ELSE manner end as manner,
	(select count(product_no) from product where seller_id in #{param1}) as prductsu ,
	(select count(product_no) from PRODUCT_JJIM where SELLER_ID in #{param1}) as jjimget ,
	(select count(product_no) from PRODUCT_JJIM where USER_ID in #{param1}) as jjimdo ,
	MEMBER_ID as id
	FROM RESET_USER where MEMBER_ID in #{param1}

</select>
<select id="getlikejjimProduct" parameterType="java.util.List" resultType="com.enez.market.product.JjimPoriductDTO">
SELECT 
	b.profile_image as profileimage,
	b.NICKNAME as nickname,
	CASE WHEN b.manner is null THEN 5 ELSE b.manner end as manner,
	a.PRODUCT_NO as productno,
	a.PRODUCT_IMAGE as pr_image,
	a.SELLER_ID as id
 FROM PRODUCT a join RESET_USER b on a.SELLER_ID =b.MEMBER_ID 
	<choose>
		<when test="list.size != 0">
			WHERE a.product_no in
			<foreach collection="list" item="item" index="index" separator="," open="(" close=")">
            	#{item}
            </foreach>
		</when>
		<otherwise>
			WHERE a.product_no in 99999
		</otherwise>
	</choose>
</select>

<select id="getFollowProfile" parameterType="java.util.List" resultType="com.enez.market.product.FollowProfileDTO">
SELECT  
	profile_image as image,
	NICKNAME as nickname,
	CASE WHEN manner is null THEN 5 ELSE manner end as manner,
	(select count(product_no)from product where seller_id in member_id) as productcount,
	MEMBER_ID as id,
	(select count(product_no)from PRODUCT_JJIM where SELLER_ID in member_id) as jjimcountget,
	(select count(product_no)from PRODUCT_JJIM where USER_ID in member_id) as jjimcountdo
 FROM 
 RESET_USER
	<choose>
		<when test="list.size != 0">
 	WHERE member_id in
			<foreach collection="list" item="item" index="index" separator="," open="(" close=")">
            	#{item}
            </foreach>
		</when>
		<otherwise>
			WHERE member_id in '_'
		</otherwise>
	</choose>
</select>
<!-- 프로덕트 디테일 product_no -->
<select id="productoutByPr_number" resultType="com.enez.market.product.ProductDTO">
	select * from product where PRODUCT_NO = #{param1}		
</select>
<delete id="deljjim">
delete from PRODUCT_JJIM where USER_ID in #{param2} and PRODUCT_NO in #{param1}
</delete>

<insert id="mainimagesave">
 insert into imagedetail 
 (image_no, main_image,member_id) 
  values (#{param1},#{param2},#{param3})
</insert>

<select id="promanager" resultType="com.enez.market.product.Product_managerDTO">
	SELECT 
    PRODUCT_NO,
    SELLER_ID,
    CATEGORY_NAME,
    BUYER_ID,
    PRICE,
    TITLE,
    DETAIL,
    LOCATION,
    PRODUCT_STATE,
    (SELECT MAIN_IMAGE FROM imagedetail WHERE image_no = PRODUCT_NO) AS main_image,
    VIEW_CNT,
    CREATE_AT,
    UPDATE_AT
FROM 
    product 
WHERE 
    seller_id=#{param1} 
ORDER BY 
    PRODUCT_NO ASC
</select>


<update id="statevlaue">
	update product set product_state = #{param1} where product_no = #{param2}
</update>

<delete id="prodelect">
    delete from product where product_no = #{param1}
</delete>
<delete id="proimage">
    delete from imagedetail where image_no = #{param1}
</delete>


<select id="update" resultType="com.enez.market.product.ProductDTO" >
    select * from product where product_no = #{param1}
</select>



<update id="update2">
    update product set product_image = #{param3}, title = #{param4}, category_name = #{param5},
    location = #{param6}, price =#{param7} , detail = #{param8} where product_no = #{param1}
</update>

<update id="mainimageup">
    update imagedetail set main_image = #{param1} where image_no = #{param3}
</update>

<select id="promember" resultType="com.enez.market.product.Product_memberDTO">
    select * from reset_user where member_id = #{param1}
</select>

<select id="prosangjum" resultType="com.enez.market.product.ProductDTO">
SELECT DISTINCT p.price, i.main_image
FROM product p
JOIN imagedetail i ON p.product_no = i.image_no
WHERE i.image_no in (select product_no from product where seller_id = #{param1})
</select>

<select id="saveproduct" resultType= "Integer">
    SELECT max(product_no) FROM product WHERE seller_id = #{param1} 
</select>

<select id="getProductsByState" parameterType="map" resultType="com.enez.market.product.Product_managerDTO">
        SELECT * FROM products WHERE product_state = #{param1}
    </select>

<select id="productout1" resultType="com.enez.market.product.ProductDTO">
	SELECT product_no,seller_id,category_name,buyer_id,price,title,detail,product_state,location,
    product_image,view_cnt,create_at,update_at,CASE WHEN EXTRACT(DAY FROM SYSDATE - update_at) = 0 THEN 
    TO_CHAR(TRUNC(MOD(EXTRACT(HOUR FROM SYSDATE - update_at), 24))) || '시간 전'
    WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, update_at) / 12) >= 1 THEN
    TO_CHAR(TRUNC(MONTHS_BETWEEN(SYSDATE, update_at) / 12)) || '년 전'
    WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, update_at)) >=1 THEN
    TO_CHAR(TRUNC(MONTHS_BETWEEN(SYSDATE, update_at))) || '달 전'
    ELSE TO_CHAR(EXTRACT(DAY FROM SYSDATE - update_at)) || '일 전'
    END as period FROM product WHERE seller_id = #{param1}	
</select>

<!-- 상품 상태별 출력 거래중,판매중,판매완료 -->
<select id="statesort" resultType="com.enez.market.product.ProductDTO">
	SELECT product_no,seller_id,category_name,buyer_id,price,title,detail,product_state,location,
    product_image,view_cnt,create_at,update_at,CASE WHEN EXTRACT(DAY FROM SYSDATE - update_at) = 0 THEN 
    TO_CHAR(TRUNC(MOD(EXTRACT(HOUR FROM SYSDATE - update_at), 24))) || '시간 전'
    WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, update_at) / 12) >= 1 THEN
    TO_CHAR(TRUNC(MONTHS_BETWEEN(SYSDATE, update_at) / 12)) || '년 전'
    WHEN TRUNC(MONTHS_BETWEEN(SYSDATE, update_at)) >=1 THEN
    TO_CHAR(TRUNC(MONTHS_BETWEEN(SYSDATE, update_at))) || '달 전'
    ELSE TO_CHAR(EXTRACT(DAY FROM SYSDATE - update_at)) || '일 전'
    END as period FROM product WHERE seller_id = #{param1} and product_state = #{param2}	
</select>


</mapper>